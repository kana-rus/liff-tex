import { ChangeEvent, useEffect, useState } from 'react'
import Head from 'next/head'
import type { NextPage } from 'next'

import styles from '../styles/main.module.css'

import katex from 'katex'
import html2canvas from 'html2canvas'


const post = (dataURL: string) => {
  const form = document.createElement('form')
  form.action = /*'https://liff-tex.vercel.app*/'/api/dlpoint?openExternalBrowser=1'
  form.method = 'post'
  form.innerHTML = `<input name='dataURL' value=${dataURL}>`
  document.body.appendChild(form)
  form.submit()
}
const postDataURLof = (element: HTMLElement) => {
  html2canvas(element)
    .then(canvas => {
      const dataURL = canvas.toDataURL()
     post(JSON.stringify(dataURL))
    })
}
const adjustKatexFontSize = (
    area: HTMLElement,
    currentText: string,
    currentFontSize: number
  ) => {
    katex.render(String.raw`${currentText}`, area, {
      throwOnError: false,
      displayMode: true
    })
    const wRate = area.clientWidth / area.scrollWidth
    const hRate = area.clientHeight / area.scrollHeight
    return currentFontSize * (wRate*wRate) * (hRate*hRate)
}


const Home: NextPage = () => {
  const [liffObject, setLiffObject] = useState<any>()
  const LiffID = process.env.LIFF_ID || ""
  useEffect(() => {
    import('@line/liff').then(liffFile => {
      const liff = liffFile.default
      liff
        .init({
          liffId: LiffID,
          withLoginOnExternalBrowser: true,
        })
        .then(() => {
          setLiffObject(liff)
        })
    })
  }, [])

  const [katexArea, setKatexArea] = useState<HTMLElement>()
  useEffect(() => {
    setKatexArea(
      document.getElementById('katex-area')!
    )
  }, [])
  const [katexFontSize, setKatexFontSize] = useState(1.6)

  const handleChange = (e: ChangeEvent<HTMLTextAreaElement>) => {
    const currentText = e.target.value
    const newKatexFontSize = adjustKatexFontSize(katexArea!, currentText, katexFontSize)
    setKatexFontSize(newKatexFontSize)
    document.documentElement.style.setProperty(
      '--katex-font-size', `${newKatexFontSize}em`
    )
  }
  const handleClick = () => {
    postDataURLof(katexArea!)
  }

  return (
    <>
      <Head>
        <title>LIFF-TEX</title>
        <meta name="description" content="Generated by create next app" />
        <link rel="icon" href="/favicon.ico" />
      </Head>
      <main className={styles.mainStyle}>
        <div className={styles.previewStyle} id="katex-area" />
        <textarea
          className={styles.inputStyle}
          onChange={(e) => handleChange(e)}
        />
        <button className={styles.buttonStyle}
          onClick={handleClick}
        >
          download
        </button>

        <a id='download-link' download='KaTeX.png' className={styles.linkStyle}>
          downloadLink
        </a>

      </main>
    </>
  )
}

export default Home
